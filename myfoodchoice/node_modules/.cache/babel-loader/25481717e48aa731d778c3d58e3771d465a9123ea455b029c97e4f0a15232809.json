{"ast":null,"code":"'use strict';\n\nconst CommandCode = require('../constants/commands.js');\nconst ClientConstants = require('../constants/client.js');\nconst Packet = require('../packets/packet.js');\nconst auth41 = require('../auth_41.js');\nconst CharsetToEncoding = require('../constants/charset_encodings.js');\n\n// https://dev.mysql.com/doc/internals/en/com-change-user.html#packet-COM_CHANGE_USER\nclass ChangeUser {\n  constructor(opts) {\n    this.flags = opts.flags;\n    this.user = opts.user || '';\n    this.database = opts.database || '';\n    this.password = opts.password || '';\n    this.passwordSha1 = opts.passwordSha1;\n    this.authPluginData1 = opts.authPluginData1;\n    this.authPluginData2 = opts.authPluginData2;\n    this.connectAttributes = opts.connectAttrinutes || {};\n    let authToken;\n    if (this.passwordSha1) {\n      authToken = auth41.calculateTokenFromPasswordSha(this.passwordSha1, this.authPluginData1, this.authPluginData2);\n    } else {\n      authToken = auth41.calculateToken(this.password, this.authPluginData1, this.authPluginData2);\n    }\n    this.authToken = authToken;\n    this.charsetNumber = opts.charsetNumber;\n  }\n\n  // TODO\n  // ChangeUser.fromPacket = function(packet)\n  // };\n  serializeToBuffer(buffer) {\n    const isSet = flag => this.flags & ClientConstants[flag];\n    const packet = new Packet(0, buffer, 0, buffer.length);\n    packet.offset = 4;\n    const encoding = CharsetToEncoding[this.charsetNumber];\n    packet.writeInt8(CommandCode.CHANGE_USER);\n    packet.writeNullTerminatedString(this.user, encoding);\n    if (isSet('SECURE_CONNECTION')) {\n      packet.writeInt8(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else {\n      packet.writeBuffer(this.authToken);\n      packet.writeInt8(0);\n    }\n    packet.writeNullTerminatedString(this.database, encoding);\n    packet.writeInt16(this.charsetNumber);\n    if (isSet('PLUGIN_AUTH')) {\n      // TODO: read this from parameters\n      packet.writeNullTerminatedString('mysql_native_password', 'latin1');\n    }\n    if (isSet('CONNECT_ATTRS')) {\n      const connectAttributes = this.connectAttributes;\n      const attrNames = Object.keys(connectAttributes);\n      let keysLength = 0;\n      for (let k = 0; k < attrNames.length; ++k) {\n        keysLength += Packet.lengthCodedStringLength(attrNames[k], encoding);\n        keysLength += Packet.lengthCodedStringLength(connectAttributes[attrNames[k]], encoding);\n      }\n      packet.writeLengthCodedNumber(keysLength);\n      for (let k = 0; k < attrNames.length; ++k) {\n        packet.writeLengthCodedString(attrNames[k], encoding);\n        packet.writeLengthCodedString(connectAttributes[attrNames[k]], encoding);\n      }\n    }\n    return packet;\n  }\n  toPacket() {\n    if (typeof this.user !== 'string') {\n      throw new Error('\"user\" connection config property must be a string');\n    }\n    if (typeof this.database !== 'string') {\n      throw new Error('\"database\" connection config property must be a string');\n    }\n    // dry run: calculate resulting packet length\n    const p = this.serializeToBuffer(Packet.MockBuffer());\n    return this.serializeToBuffer(Buffer.allocUnsafe(p.offset));\n  }\n}\nmodule.exports = ChangeUser;","map":{"version":3,"names":["CommandCode","require","ClientConstants","Packet","auth41","CharsetToEncoding","ChangeUser","constructor","opts","flags","user","database","password","passwordSha1","authPluginData1","authPluginData2","connectAttributes","connectAttrinutes","authToken","calculateTokenFromPasswordSha","calculateToken","charsetNumber","serializeToBuffer","buffer","isSet","flag","packet","length","offset","encoding","writeInt8","CHANGE_USER","writeNullTerminatedString","writeBuffer","writeInt16","attrNames","Object","keys","keysLength","k","lengthCodedStringLength","writeLengthCodedNumber","writeLengthCodedString","toPacket","Error","p","MockBuffer","Buffer","allocUnsafe","module","exports"],"sources":["C:/Users/runes/FYP/myfoodchoice/node_modules/mysql2/lib/packets/change_user.js"],"sourcesContent":["'use strict';\n\nconst CommandCode = require('../constants/commands.js');\nconst ClientConstants = require('../constants/client.js');\nconst Packet = require('../packets/packet.js');\nconst auth41 = require('../auth_41.js');\nconst CharsetToEncoding = require('../constants/charset_encodings.js');\n\n// https://dev.mysql.com/doc/internals/en/com-change-user.html#packet-COM_CHANGE_USER\nclass ChangeUser {\n  constructor(opts) {\n    this.flags = opts.flags;\n    this.user = opts.user || '';\n    this.database = opts.database || '';\n    this.password = opts.password || '';\n    this.passwordSha1 = opts.passwordSha1;\n    this.authPluginData1 = opts.authPluginData1;\n    this.authPluginData2 = opts.authPluginData2;\n    this.connectAttributes = opts.connectAttrinutes || {};\n    let authToken;\n    if (this.passwordSha1) {\n      authToken = auth41.calculateTokenFromPasswordSha(\n        this.passwordSha1,\n        this.authPluginData1,\n        this.authPluginData2\n      );\n    } else {\n      authToken = auth41.calculateToken(\n        this.password,\n        this.authPluginData1,\n        this.authPluginData2\n      );\n    }\n    this.authToken = authToken;\n    this.charsetNumber = opts.charsetNumber;\n  }\n\n  // TODO\n  // ChangeUser.fromPacket = function(packet)\n  // };\n  serializeToBuffer(buffer) {\n    const isSet = flag => this.flags & ClientConstants[flag];\n    const packet = new Packet(0, buffer, 0, buffer.length);\n    packet.offset = 4;\n    const encoding = CharsetToEncoding[this.charsetNumber];\n    packet.writeInt8(CommandCode.CHANGE_USER);\n    packet.writeNullTerminatedString(this.user, encoding);\n    if (isSet('SECURE_CONNECTION')) {\n      packet.writeInt8(this.authToken.length);\n      packet.writeBuffer(this.authToken);\n    } else {\n      packet.writeBuffer(this.authToken);\n      packet.writeInt8(0);\n    }\n    packet.writeNullTerminatedString(this.database, encoding);\n    packet.writeInt16(this.charsetNumber);\n    if (isSet('PLUGIN_AUTH')) {\n      // TODO: read this from parameters\n      packet.writeNullTerminatedString('mysql_native_password', 'latin1');\n    }\n    if (isSet('CONNECT_ATTRS')) {\n      const connectAttributes = this.connectAttributes;\n      const attrNames = Object.keys(connectAttributes);\n      let keysLength = 0;\n      for (let k = 0; k < attrNames.length; ++k) {\n        keysLength += Packet.lengthCodedStringLength(attrNames[k], encoding);\n        keysLength += Packet.lengthCodedStringLength(\n          connectAttributes[attrNames[k]],\n          encoding\n        );\n      }\n      packet.writeLengthCodedNumber(keysLength);\n      for (let k = 0; k < attrNames.length; ++k) {\n        packet.writeLengthCodedString(attrNames[k], encoding);\n        packet.writeLengthCodedString(\n          connectAttributes[attrNames[k]],\n          encoding\n        );\n      }\n    }\n    return packet;\n  }\n\n  toPacket() {\n    if (typeof this.user !== 'string') {\n      throw new Error('\"user\" connection config property must be a string');\n    }\n    if (typeof this.database !== 'string') {\n      throw new Error('\"database\" connection config property must be a string');\n    }\n    // dry run: calculate resulting packet length\n    const p = this.serializeToBuffer(Packet.MockBuffer());\n    return this.serializeToBuffer(Buffer.allocUnsafe(p.offset));\n  }\n}\n\nmodule.exports = ChangeUser;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}